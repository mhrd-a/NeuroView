<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Eye Tracking with WebGazer.js</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container card">
    <h1>Eye Tracking Analysis</h1>

    <div class="input-group">
      <label for="testTakerName">Test Taker Name:</label>
      <input type="text" id="testTakerName" placeholder="Enter your name" />
    </div>

    <div class="input-group">
      <label for="imageUrl">Webpage URL (static):</label>
      <input type="text" id="imageUrl" placeholder="https://example.com" />
    </div>

    <div class="input-group">
      <label for="imageFile">Or Upload Image:</label>
      <input type="file" id="imageFile" accept="image/*" />
    </div>

    <div class="input-group">
      <label for="duration">Tracking Duration (seconds):</label>
      <input type="number" id="duration" value="30" />
    </div>

    <button class="btn" onclick="startEyeTracking()">Start Eye Tracking</button>
    <div id="status-message" class="status-info">Initializing WebGazer...</div>
  </div>

  <!-- Calibration Overlay -->
  <div id="calibrationOverlay" class="fullscreen-overlay hidden"></div>

  <!-- Timer -->
  <div id="timer" class="timer hidden">0</div>

  <script>
    let gazeData = [];
    let trackingInterval;
    let calibrationPoints = [];
    let iframeLoaded = false;

    window.onload = () => {
      webgazer.setRegression('ridge')
              .setGazeListener((data, timestamp) => {
                if (data) {
                  const dot = document.createElement('div');
                  dot.className = 'gaze-dot';
                  dot.style.left = `${data.x}px`;
                  dot.style.top = `${data.y}px`;
                  document.body.appendChild(dot);
                  setTimeout(() => dot.remove(), 2000);
                  gazeData.push({ timestamp, x: data.x, y: data.y });
                }
              }).begin()
              .showVideoPreview(false)
              .showPredictionPoints(false)
              .showFaceOverlay(false)
              .showFaceFeedbackBox(false);
    };

    function startEyeTracking() {
      gazeData = [];
      const name = document.getElementById('testTakerName').value.trim();
      const imageUrlInput = document.getElementById('imageUrl').value.trim();
      const fileInput = document.getElementById('imageFile');
      const duration = parseInt(document.getElementById('duration').value, 10);

      if (!imageUrlInput && fileInput.files.length === 0) {
        alert('Please enter a webpage URL or upload an image.');
        return;
      }

      document.querySelector('.container').style.display = 'none';
      document.getElementById('status-message').textContent = 'Loading background...';

      if (imageUrlInput) {
        const iframe = document.createElement('iframe');
        iframe.src = imageUrlInput;
        iframe.className = 'background-frame';
        iframe.setAttribute('sandbox', 'allow-same-origin');
        iframe.onload = () => {
          iframeLoaded = true;
          setupCalibration(duration, name);
        };
        iframe.onerror = () => {
          alert('Failed to load the webpage. Make sure the URL is correct and accessible.');
        };
        document.body.appendChild(iframe);
      } else {
        const img = new Image();
        img.onload = () => {
          img.className = 'fullscreen-bg';
          document.body.appendChild(img);
          setupCalibration(duration, name);
        };
        img.onerror = () => {
          alert('Failed to load the uploaded image.');
        };
        img.src = URL.createObjectURL(fileInput.files[0]);
      }
    }

    function setupCalibration(duration, name) {
      document.getElementById('status-message').textContent = 'Calibration starting...';
      const overlay = document.getElementById('calibrationOverlay');
      overlay.innerHTML = '';
      overlay.classList.remove('hidden');

      const rows = 3, cols = 3;
      const width = window.innerWidth;
      const height = window.innerHeight;

      calibrationPoints = [];

      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const point = document.createElement('div');
          point.className = 'calibration-point';
          point.style.left = `${(c + 0.5) * width / cols}px`;
          point.style.top = `${(r + 0.5) * height / rows}px`;
          overlay.appendChild(point);
          calibrationPoints.push(point);
        }
      }

      let current = 0;

      function highlightNextPoint() {
        if (current > 0) calibrationPoints[current - 1].style.background = 'red';
        if (current < calibrationPoints.length) {
          calibrationPoints[current].style.background = 'lime';
          current++;
          setTimeout(highlightNextPoint, 1000);
        } else {
          overlay.classList.add('hidden');
          document.getElementById('status-message').textContent = 'Tracking in progress...';
          startTracking(duration, name);
        }
      }

      highlightNextPoint();
    }

    function startTracking(duration, name) {
      const timerEl = document.getElementById('timer');
      timerEl.classList.remove('hidden');
      let remaining = duration;
      timerEl.textContent = `${remaining}s`;

      trackingInterval = setInterval(() => {
        remaining--;
        timerEl.textContent = `${remaining}s`;
        if (remaining <= 0) {
          clearInterval(trackingInterval);
          webgazer.pause();
          document.getElementById('status-message').textContent = 'Tracking complete. Saving data...';
          timerEl.classList.add('hidden');
          saveResults(name);
        }
      }, 1000);
    }

    function saveResults(name) {
      // Save Excel
      const worksheet = XLSX.utils.json_to_sheet(gazeData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'GazeData');
      XLSX.writeFile(workbook, `gaze_data_${name || 'user'}.xlsx`);

      document.getElementById('status-message').textContent = 'Data saved successfully.';
    }
  </script>
</body>
</html>
